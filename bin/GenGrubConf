#!/bin/bash

if [ $# -lt 1 ]
then
	echo "Syntax: $0 <grubDir> [<oldUUID> <newUUID>]"
	exit 1
fi

export GRUB_DISTRIBUTOR="GoboLinux"
GRUB_DIR="$1"
shift

OLD_UUID=
NEW_UUID=
if [ ! -z "$1" -a ! -z "$2" ]
then
    OLD_UUID="$1"
    NEW_UUID="$2"
fi

# Create the config file
if [ ! -d "$GRUB_DIR" ]
then
    mkdir -p "$GRUB_DIR"
fi
grub-mkconfig -o "$GRUB_DIR/grub.cfg"

# Make sure old UUID is no longer present in the cfg file
if [ "x$OLD_UUID" != "x$NEW_UUID" ]
then
    GrepReplace -B "$OLD_UUID" "$NEW_UUID" "$GRUB_DIR/grub.cfg"
fi

# The kernel doesn't know about /System/Kernel/Devices
GrepReplace -B /System/Kernel/Devices /dev "$GRUB_DIR/grub.cfg"

# Make the OS string prettier
GOBO_VERSION=$(cat /System/Settings/GoboLinuxVersion)
GrepReplace -B "GoboLinux GNU/Linux" "GoboLinux $GOBO_VERSION" "$GRUB_DIR/grub.cfg"
GrepReplace -B "GoboLinux, with Linux[^\'\(]*" "GoboLinux $GOBO_VERSION with VESA framebuffer driver" "$GRUB_DIR/grub.cfg"
GrepReplace -B "driver(" "driver (" "$GRUB_DIR/grub.cfg"

# All options: Make console UTF-8
sed -i 's,\(\tlinux.*Gobo.*\),\1 vt.default_utf8=1,g' "$GRUB_DIR/grub.cfg"

# All options: Limit number of ramdisks, override Apple HID driver default settings
sed -i 's,vt.default_utf8=1,vt.default_utf8=1 brd.rd_nr=0 hid_apple.iso_layout=0 hid_apple.fnmode=2,g' "$GRUB_DIR/grub.cfg"

# All options: Wait until the root device becomes available
sed -i 's,vt.default_utf8=1,vt.default_utf8=1 rootwait,g' "$GRUB_DIR/grub.cfg"

# First option: Enable output on all connected monitors, disable vesafb
sed -i -e '0,/default_utf8=1/s@default_utf8=1@default_utf8=1 video=LVDS-1:e video=HDMI-1:e video=VGA=1:e video=vesafb:off@' "$GRUB_DIR/grub.cfg"

# First option: Quiet output
sed -i -e '0,/default_utf8=1/s@default_utf8=1@default_utf8=1 console=/dev/null@' "$GRUB_DIR/grub.cfg"
