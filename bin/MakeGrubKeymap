#!/bin/bash

kbd_to_grub() {
   case "$1" in
   "Escape") value="escape" ;;
   "Tab") value="tab" ;;
   "Return") value="enter" ;;
   "Control") value="control" ;;
   "Shift") value="shift" ;;
   "Alt") value="alt" ;;
   "asciicircum") value="caret" ;;
   "asciitilde") value="tilde" ;;
   "apostrophe") value="quote" ;;
   "quotedbl") value="doublequote" ;;
   "grave") value="backquote" ;;
   "Caps_Lock") value="capslock" ;;
   "Delete") value="delete" ;;
   "zero") value="0" ;;
   "one") value="1" ;;
   "two") value="2" ;;
   "three") value="3" ;;
   "four") value="4" ;;
   "five") value="5" ;;
   "six") value="6" ;;
   "seven") value="7" ;;
   "eight") value="8" ;;
   "nine") value="9" ;;
   +*) value="${1:1}" ;;
   *) value="$1" ;;
   esac
   echo "$value"
}

us_code() {
   qwerty=""
   case "$1" in
   1) qwerty="escape" ;;
   2) qwerty="1" ;;
   3) qwerty="2" ;;
   4) qwerty="3" ;;
   5) qwerty="4" ;;
   6) qwerty="5" ;;
   7) qwerty="6" ;;
   8) qwerty="7" ;;
   9) qwerty="8" ;;
   10) qwerty="9" ;;
   11) qwerty="0" ;;
   12) qwerty="minus" ;;
   13) qwerty="equal" ;;
   14) qwerty="delete" ;;
   15) qwerty="tab" ;;
   16) qwerty="q" ;;
   17) qwerty="w" ;;
   18) qwerty="e" ;;
   19) qwerty="r" ;;
   20) qwerty="t" ;;
   21) qwerty="y" ;;
   22) qwerty="u" ;;
   23) qwerty="i" ;;
   24) qwerty="o" ;;
   25) qwerty="p" ;;
   26) qwerty="bracketleft" ;;
   27) qwerty="bracketright" ;;
   28) qwerty="enter" ;;
   29) qwerty="control" ;;
   30) qwerty="a" ;;
   31) qwerty="s" ;;
   32) qwerty="d" ;;
   33) qwerty="f" ;;
   34) qwerty="g" ;;
   35) qwerty="h" ;;
   36) qwerty="j" ;;
   37) qwerty="k" ;;
   38) qwerty="l" ;;
   39) qwerty="semicolon" ;;
   40) qwerty="quote" ;;
   41) qwerty="backquote" ;;
   42) qwerty="shift" ;;
   43) qwerty="backslash" ;;
   44) qwerty="z" ;;
   45) qwerty="x" ;;
   46) qwerty="c" ;;
   47) qwerty="v" ;;
   48) qwerty="b" ;;
   49) qwerty="n" ;;
   50) qwerty="m" ;;
   51) qwerty="comma" ;;
   52) qwerty="period" ;;
   53) qwerty="slash" ;;
   54) qwerty="shift" ;;
   56) qwerty="alt" ;;
   57) qwerty="space" ;;
   58) qwerty="capslock" ;;
   59) qwerty="F1" ;;
   60) qwerty="F2" ;;
   61) qwerty="F3" ;;
   62) qwerty="F4" ;;
   63) qwerty="F5" ;;
   64) qwerty="F6" ;;
   65) qwerty="F7" ;;
   66) qwerty="F8" ;;
   67) qwerty="F9" ;;
   68) qwerty="F10" ;;
   86) qwerty="less" ;;
   87) qwerty="F11" ;;
   88) qwerty="F12" ;;
   97) qwerty="control" ;;
   113) qwerty="F13" ;;
   114) qwerty="F14" ;;
   117) qwerty="F17" ;;
   esac
   echo "$qwerty"
}

us_scode() {
   sqwerty=""
   case "$1" in
   2) sqwerty="exclam" ;;
   3) sqwerty="at" ;;
   4) sqwerty="numbersign" ;;
   5) sqwerty="dollar" ;;
   6) sqwerty="percent" ;;
   7) sqwerty="caret" ;;
   8) sqwerty="ampersand" ;;
   9) sqwerty="asterisk" ;;
   10) sqwerty="parenleft" ;;
   11) sqwerty="parenright" ;;
   12) sqwerty="underscore" ;;
   13) sqwerty="plus" ;;
   16) sqwerty="Q" ;;
   17) sqwerty="W" ;;
   18) sqwerty="E" ;;
   19) sqwerty="R" ;;
   20) sqwerty="T" ;;
   21) sqwerty="Y" ;;
   22) sqwerty="U" ;;
   23) sqwerty="I" ;;
   24) sqwerty="O" ;;
   25) sqwerty="P" ;;
   26) sqwerty="braceleft" ;;
   27) sqwerty="braceright" ;;
   30) sqwerty="A" ;;
   31) sqwerty="S" ;;
   32) sqwerty="D" ;;
   33) sqwerty="F" ;;
   34) sqwerty="G" ;;
   35) sqwerty="H" ;;
   36) sqwerty="J" ;;
   37) sqwerty="K" ;;
   38) sqwerty="L" ;;
   39) sqwerty="colon" ;;
   40) sqwerty="doublequote" ;;
   41) sqwerty="tilde" ;;
   43) sqwerty="bar" ;;
   44) sqwerty="Z" ;;
   45) sqwerty="X" ;;
   46) sqwerty="C" ;;
   47) sqwerty="V" ;;
   48) sqwerty="B" ;;
   49) sqwerty="N" ;;
   50) sqwerty="M" ;;
   51) sqwerty="less" ;;
   52) sqwerty="greater" ;;
   53) sqwerty="question" ;;
   59) sqwerty="F13" ;;
   60) sqwerty="F14" ;;
   61) sqwerty="F15" ;;
   62) sqwerty="F16" ;;
   63) sqwerty="F17" ;;
   64) sqwerty="F18" ;;
   65) sqwerty="F19" ;;
   66) sqwerty="F20" ;;
   67) sqwerty="F21" ;;
   68) sqwerty="F22" ;;
   86) sqwerty="greater" ;;
   87) sqwerty="F23" ;;
   88) sqwerty="F24" ;;
   113) sqwerty="F13" ;;
   114) sqwerty="F14" ;;
   117) sqwerty="F17" ;;
   esac 
   echo "$sqwerty"
}

if ! type dumpkeys &> /dev/null
then
   echo "Error: dumpkeys utility not found." 1>&2
   echo "This script requires the kbd package." 1>&2
   exit 1
fi

dumpkeys --full-table | grep "^keycode" | while read line
do
   keycode=`echo "$line" | sed 's/keycode[ \t]*\([0-9]*\)[ \t].*/\1/'`
   value=`echo "$line" | sed 's/keycode[ \t]*[0-9]*[ \t]*=[ \t]*\([^ \t]*\).*/\1/'`
   svalue=`echo "$line" | sed 's/keycode[ \t]*[0-9]*[ \t]*=[ \t]*\([^ \t]*\)[ \t]*\([^ \t]*\)*.*/\2/'`
   if [ "$keycode" -gt "117" ]
   then
      break
   fi
   #echo "keycode $keycode value $value svalue $svalue"
   if [ "$value" != "VoidSymbol" ]
   then
      value=`kbd_to_grub "$value"`
      qwerty=`us_code "$keycode"`
      if [ -n "$qwerty" -a "$value" != "$qwerty" ]
      then
         echo "setkey $value $qwerty"
      fi
      if [ "$svalue" != "VoidSymbol" ]
      then
         svalue=`kbd_to_grub "$svalue"`
         sqwerty=`us_scode "$keycode"`
         if [ -n "$sqwerty" -a "$svalue" != "$sqwerty" ]
         then
            echo "setkey $svalue $sqwerty"
         fi
      fi
   fi
done
