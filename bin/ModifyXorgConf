#!/bin/bash

# Quick and dirty X configurator
# by Hisham Muhammad, 2003.

#
# Changelog
#
# ??/??/2003 - [hisham] First version
# 12/11/2003 - [gbedin] support Live-CD, Keymap from the setup directory
# 19/10/2004 - [detsch] generating xorg.conf
# 20/04/2005 - ConfigTools overhaul
# 22/04/2005 - [calica] Convert from ConfigureX11 to ModifyXorgConf
# 24/04/2005 - [detsch] Getting KeymapLayout as parameter
# 17/05/2005 - [lucasv] Fixed the keyboard stuff, 'grep -v Viewport'

. ScriptFunctions

mkdir -p ${goboTemp}/setup
cd ${goboTemp}/setup

if [ "$1" ] 
then
    KeymapLayout="$1"
else
    echo "Warning: KeymapLayout not passed as arg1. Assuming 'us'" 1>&2
    KeymapLayout="us"
fi

tempfile=`mktemp ${goboTemp}/setup/xorg.conf.new.XXXXX`
cat - >$tempfile

function apply_sed() {
  mv ${tempfile} ${tempfile}.tmp
  sed "$1" ${tempfile}.tmp > ${tempfile}
  rm ${tempfile}.tmp
}

function apply_ed() {
# BEHOLD!!! The beginning of a new era!!!
  ed ${tempfile} <<EOF &> /dev/null
/$1
+
i
$2
.
w ${tempfile}.tmp
EOF
  mv ${tempfile}.tmp ${tempfile}
}

apply_sed "s%/Programs/.*/lib/xorg/modules%/System/Links/Libraries/xorg/modules%"
apply_sed "s%/Programs/.*/share/X11/rgb%/System/Links/Shared/X11/rgb%"
apply_sed "s%/Programs/.*/fonts%/Files/Fonts%"
apply_sed "s%/Files/Fonts/misc%/Files/Fonts/Misc%"

if Quiet grep '"Protocol".*"auto"' ${tempfile}
then
  MouseOptions=(`MouseInfo simple`)
  MouseDevice=${MouseOptions[0]}
  MouseType=${MouseOptions[1]}
  MouseXProtocol=${MouseOptions[2]}
  Emulate3Buttons=${MouseOptions[3]}
  if [ -n "$MouseOptions" ]
  then
     apply_sed "s%/dev/mouse%$MouseDevice%"
     apply_sed "s%\"auto\"%\"$MouseXProtocol\"%"
     [ "$MouseXProtocol" = "IMPS/2" ] && apply_ed '"mouse"' '        Option "ZAxisMapping" "4 5"'
     [ "$Emulate3Buttons" == "yes" ]  && apply_ed '"mouse"' '        Option "Emulate3Buttons" "yes"'
  fi
fi

if ! Quiet grep '"XkbModel"' ${tempfile}
then
  if [ -n "$KeymapLayout"  ]
  then
     Log_Normal "Your keymap layout is '$KeymapLayout'."
     case "$KeymapLayout" in
     "be-latin1")
        apply_ed 'Driver      "kbd"' '        Option "XkbModel" "pc104"'
        apply_ed 'Driver      "kbd"' '        Option "XkbLayout" "be"'
        ;;
     "br-abnt2")
        apply_ed 'Driver      "kbd"' '        Option "XkbModel" "abnt2"'
        apply_ed 'Driver      "kbd"' '        Option "XkbLayout" "br"'
        ;;
     "br-abnt")
        apply_ed 'Driver      "kbd"' '        Option "XkbModel" "abnt"'
        apply_ed 'Driver      "kbd"' '        Option "XkbLayout" "br"'
        ;;
     "us-acentos")
        apply_ed 'Driver      "kbd"' '        Option "XkbModel" "pc105"'
        apply_ed 'Driver      "kbd"' '        Option "XkbLayout" "us_intl"'
        ;;
     "us")
        apply_ed 'Driver      "kbd"' '        Option "XkbModel" "pc104"'
        apply_ed 'Driver      "kbd"' '        Option "XkbLayout" "us"'
        ;;
     "dvorak")
        apply_ed 'Driver      "kbd"' '        Option "XkbModel" "pc105"'
        apply_ed 'Driver      "kbd"' '        Option "XkbLayout" "dvorak"'
        ;;
     *)
        apply_ed 'Driver      "kbd"' '        Option "XkbModel" "pc104"'
        apply_ed 'Driver      "kbd"' '        Option "XkbLayout" "'$KeymapLayout'"'
        ;;
     *)
        ;;
     esac # esac is truly ridiculous.
  fi
fi

apply_ed '"Monitor"' '        HorizSync 28-50'
apply_ed '"Monitor"' '        VertRefresh 43-75'

if Quiet grep '"neomagic"' ${tempfile}
then
  apply_ed '"neomagic"' '        Option "OverlayMem" "829440"'
fi

apply_ed 'Section "Screen"' '        DefaultDepth 24'
apply_ed 'Depth     24' '                Modes "1600x1200" "1400x1050" "1280x1024" "1280x960" "1280x854" "1280x800" "1152x864" "1024x768" "800x600" "640x480"'

cat ${tempfile} | grep -v Viewport
#mv xorg.conf.new ${goboTemp}/setup/xorg.conf
